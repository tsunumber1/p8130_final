---
title: "Breast cancer survival prediction"
author: "Tong Su"
date: "2024-12-19"
output: github_document
---

```{r setup, include=FALSE}
# Load required libraries
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(caret)
library(ROCR)
library(tidyr)
library(reshape2)
library(corrplot)
library(car)
```

```{r}
# Load dataset
data <- read.csv("./data/Project_2_data.csv")
```

# 1. Descriptive Summary
```{r}
# summary_stats for numeric predictors
summary_numeric <- data |> 
  select_if(is.numeric) |>
  summarise_all(list(
    mean = ~mean(.x, na.rm = TRUE), 
    median = ~median(.x, na.rm = TRUE), 
    sd = ~sd(.x, na.rm = TRUE),
    min = ~min(.x, na.rm = TRUE),
    max = ~max(.x, na.rm = TRUE),
    iqr = ~IQR(.x, na.rm = TRUE),
    count = ~sum(!is.na(.x))
  ))

summary_numeric_long <- summary_numeric |> 
  pivot_longer(
    cols = everything(),        
    names_to = c("Variable", "Statistic"), 
    names_sep = "_",            
    values_to = "Value"         
  )
summary_numeric_wide <- summary_numeric_long |> 
  pivot_wider(
    names_from = Statistic,    
    values_from = Value         
  )
summary_numeric_wide

#summary_stats for categorical predictors
summary_categorical <- data |> 
  select_if(is.character) |>   
  summarise_all(~ {
    freq_table <- table(.)
    summary <- paste(
      paste0(names(freq_table), " (", as.vector(freq_table), " - ", 
             round(prop.table(freq_table) * 100, 2), "%)"), 
      collapse = "; "
    )
    summary
  })

summary_categorical_long <- summary_categorical |> 
  pivot_longer(
    cols = everything(), 
    names_to = "Variable",
    values_to = "Summary"
  ) |> 
  unnest(Summary)

summary_categorical_long

# Missing data
missing_percentage <- data |> 
  summarise(across(everything(), ~ mean(is.na(.)) * 100, .names = "missing_pct_{.col}"))
missing_percentage
```

# Clean Data

```{r data_cleaning}
lapply(data, unique)

data_cleaned <- data %>%
  mutate(
    Race = factor(Race),
    Marital.Status = factor(trimws(Marital.Status)),
    T.Stage = factor(T.Stage),
    N.Stage = factor(N.Stage),
    X6th.Stage = factor(X6th.Stage),
    differentiate = factor(differentiate),
    Grade = factor(trimws(Grade)),  # Trim spaces before factoring
    A.Stage = factor(A.Stage),
    Estrogen.Status = factor(Estrogen.Status),
    Progesterone.Status = factor(Progesterone.Status),
    Status = factor(Status)
  ) %>% 
  mutate(
    # For Grade, assuming order: 1 < 2 < 3 < anaplastic; Grade IV
    Grade = factor(Grade, levels = c("1", "2", "3", "anaplastic; Grade IV"), ordered = TRUE),
    # For X6th.Stage, assuming the natural order: IIA < IIB < IIIA < IIIB < IIIC
    X6th.Stage = factor(X6th.Stage, levels = c("IIA", "IIB", "IIIA", "IIIB", "IIIC"), ordered = TRUE),
    # For A.Stage, assuming Regional < Distant
    A.Stage = factor(A.Stage, levels = c("Regional", "Distant"), ordered = TRUE),
    # T.Stage: T1 < T2 < T3 < T4
    T.Stage = factor(T.Stage, levels = c("T1", "T2", "T3", "T4"), ordered = TRUE),
    # N.Stage: N1 < N2 < N3
    N.Stage = factor(N.Stage, levels = c("N1", "N2", "N3"), ordered = TRUE)
  )

```

`Grade` and `differentiate` are redundant, so we need to keep only one.

# 2. Data Visualization
```{r}
# Distribution of continuous variables
numeric_vars <- data |> select_if(is.numeric)

# Histogram for continuous variables
for (col in names(numeric_vars)) {
  ggplot(data, aes_string(x = col)) +
    geom_histogram(bins = 30, fill = "blue", color = "black") +
    ggtitle(paste("Distribution of", col)) +
    theme_minimal()
}

# Scatter plot for continuous variables
predictors = c("Age", "Tumor.Size", "Regional.Node.Examined", "Reginol.Node.Positive")
sorted_data = melt(data, id.vars = "Survival.Months", measure.vars = predictors)
ggplot(sorted_data, aes(x = value, y = Survival.Months)) +
  geom_point(alpha = 1) +
  geom_smooth(method = "lm", color = "blue") +
  facet_wrap(~variable, scales = "free_x") +  
  labs(title = "Scatter Plots of Predictors vs Survival Time",
       x = "Predictor Value",
       y = "Survival Time (Months)") +
  theme_minimal()

# Correlation heatmap
cor_matrix <- cor(numeric_vars, use = "complete.obs")
ggplot(melt(cor_matrix), aes(Var1, Var2, fill = value)) + 
  geom_tile() + 
  scale_fill_gradient2() + 
  ggtitle("Correlation Heatmap") + 
  theme_minimal()

# Correlation heatmap with correlation coefficient
corrplot(cor_matrix, method = "number", type = "full", tl.col = "black", tl.srt = 45, title = "Correlation Heatmap")

# Bar Plot for categorical variables
categorical_vars <- names(data)[sapply(data, is.factor) | sapply(data, is.character)]
if (length(categorical_vars) > 0) {
  for (var in categorical_vars) {
    p <- ggplot(data, aes_string(x = var, fill = var)) +
      geom_bar() +
      labs(
        title = paste("Distribution of", var),
        x = var,
        y = "Count"
      ) +
      theme_minimal() +
      scale_fill_brewer(palette = "Set2")  
    
    print(p)  
  }
} else {
  message("No categorical variables found in the dataset.")
}
```

# 3. Model Building: Survival Analysis
```{r}
# Convert Status to binary (Dead = 1, Alive = 0)
data$Status <- ifelse(data$Status == "Dead", 1, 0)

# Build Cox Proportional Hazards model
cox_model <- coxph(Surv(Survival.Months, Status) ~ ., data = data)
summary(cox_model)

# Save model summary
tidy_cox <- broom::tidy(cox_model)
write.csv(tidy_cox, "cox_model_summary.csv")

# Evaluate Model Performance
# Concordance index
c_index <- summary(cox_model)$concordance
cat("Concordance Index:", c_index, "\n")
```

# Varibales selection
```{r}
# Building model
logistic_full <- glm(Status ~ ., family = binomial, data = data_cleaned)
logistic_null <- glm(Status ~ 1, family = binomial, data = data_cleaned)

# backward selection
backward_model <- step(logistic, direction = "backward")
AIC(backward_model)

# forward selection
forward_model <- step(logistic_null, scope = list(lower = logistic_full, upper = logistic_null), direction = "forward")
AIC(forward_model)

# stepwise selection
stepwise <- step(null_logistic, scope = list(lower = logistic_full, upper = logistic_null), direction = "both")

# examine if the same model was build
formula(backward_model)
formula(forward_model)
formula(stepwise)

# check if there is a close call
summary(backward_model)
summary(forward_model)
summary(stepwise)
```




# 4. Fairness Analysis


