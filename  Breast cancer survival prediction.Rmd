---
title: "Breast cancer survival prediction"
author: "Tong Su"
date: "2024-12-19"
output: github_document
---

```{r setup, include=FALSE}
# Load required libraries
library(dplyr)
library(ggplot2)
library(survival)
library(survminer)
library(caret)
library(ROCR)
library(tidyr)
library(reshape2)
library(corrplot)
library(car)
```

```{r}
# Load dataset
data <- read.csv("./data/Project_2_data.csv")

# Clean dataset
lapply(data, table)

data_cleaned <- data %>%
  mutate(
    Race = factor(Race),
    Marital.Status = factor(trimws(Marital.Status)),
    T.Stage = factor(T.Stage),
    N.Stage = factor(N.Stage),
    X6th.Stage = factor(X6th.Stage),
    differentiate = factor(differentiate),
    Grade = factor(trimws(Grade)),  # Trim spaces before factoring
    A.Stage = factor(A.Stage),
    Estrogen.Status = factor(Estrogen.Status),
    Progesterone.Status = factor(Progesterone.Status),
    Status = factor(Status)
  ) %>% 
  mutate(
    T.Stage = as.numeric(factor(T.Stage, levels = c("T1", "T2", "T3", "T4"), ordered = TRUE)),
    N.Stage = as.numeric(factor(N.Stage, levels = c("N1", "N2", "N3"), ordered = TRUE)),
    X6th.Stage = as.numeric(factor(X6th.Stage, levels = c("IIA", "IIB", "IIIA", "IIIB", "IIIC"), ordered = TRUE)),
    Grade = as.numeric(factor(Grade, levels = c("1", "2", "3", "anaplastic; Grade IV"), ordered = TRUE)),
    A.Stage = as.numeric(factor(A.Stage, levels = c("Regional", "Distant"), ordered = TRUE))
  ) %>% 
  select(-differentiate)
```

`Grade` and `differentiate` are redundant variables, so we drop `differentiate`.

# 1. Descriptive Summary
```{r}
# summary_stats for numeric predictors
summary_numeric <- data_cleaned |> 
  select_if(is.numeric) |>
  summarise_all(list(
    mean = ~mean(.x, na.rm = TRUE), 
    median = ~median(.x, na.rm = TRUE), 
    sd = ~sd(.x, na.rm = TRUE),
    min = ~min(.x, na.rm = TRUE),
    max = ~max(.x, na.rm = TRUE),
    iqr = ~IQR(.x, na.rm = TRUE),
    count = ~sum(!is.na(.x))
  ))

summary_numeric_long <- summary_numeric |> 
  pivot_longer(
    cols = everything(),        
    names_to = c("Variable", "Statistic"), 
    names_sep = "_",            
    values_to = "Value"         
  )
summary_numeric_wide <- summary_numeric_long |> 
  pivot_wider(
    names_from = Statistic,    
    values_from = Value         
  )
summary_numeric_wide

# Missing data
missing_percentage <- data_cleaned |> 
  summarise(across(everything(), ~ mean(is.na(.)) * 100, .names = "missing_pct_{.col}"))
missing_percentage
```


# 2. Data Visualization
```{r}
# Distribution of continuous variables
numeric_vars <- data_cleaned |> select_if(is.numeric)

# Histogram for continuous variables
for (col in names(numeric_vars)) {
  ggplot(data_cleaned, aes_string(x = col)) +
    geom_histogram(bins = 30, fill = "blue", color = "black") +
    ggtitle(paste("Distribution of", col)) +
    theme_minimal()
}

# Scatter plot for continuous variables
predictors = c("Age", "Tumor.Size", "Regional.Node.Examined", "Reginol.Node.Positive")
sorted_data = melt(data_cleaned, id.vars = "Survival.Months", measure.vars = predictors)
ggplot(sorted_data, aes(x = value, y = Survival.Months)) +
  geom_point(alpha = 1) +
  geom_smooth(method = "lm", color = "blue") +
  facet_wrap(~variable, scales = "free_x") +  
  labs(title = "Scatter Plots of Predictors vs Survival Time",
       x = "Predictor Value",
       y = "Survival Time (Months)") +
  theme_minimal()

# Correlation heatmap with correlation coefficient
cor_matrix <- cor(numeric_vars, use = "complete.obs")
corrplot(cor_matrix, method = "number", type = "full", tl.col = "black", tl.srt = 45, title = "Correlation Heatmap")

# Bar Plot for categorical variables
categorical_vars <- names(data_cleaned)[sapply(data_cleaned, is.factor) | sapply(data_cleaned, is.character)]
if (length(categorical_vars) > 0) {
  for (var in categorical_vars) {
    p <- ggplot(data_cleaned, aes_string(x = var, fill = var)) +
      geom_bar() +
      labs(
        title = paste("Distribution of", var),
        x = var,
        y = "Count"
      ) +
      theme_minimal() +
      scale_fill_brewer(palette = "Set2")  
    
    print(p)  
  }
} else {
  message("No categorical variables found in the dataset.")
}

#show pairs with strong correlation
for (i in 1:(nrow(cor_matrix) - 1)) {
  for (j in (i + 1):ncol(cor_matrix)) {
    if (abs(cor_matrix[i, j]) > 0.7) {
      cat("Pairs with strong correlation:", rownames(cor_matrix)[i], "~", colnames(cor_matrix)[j], 
          "with correlation =", cor_matrix[i, j], "\n")
    }
  }
}
```

# 3. Model Building: Survival Analysis
```{r}
# Convert Status to binary (Dead = 1, Alive = 0)
data$Status <- ifelse(data$Status == "Dead", 1, 0)

# Build Cox Proportional Hazards model
cox_model <- coxph(Surv(Survival.Months, Status) ~ ., data = data)
summary(cox_model)

# Save model summary
tidy_cox <- broom::tidy(cox_model)
write.csv(tidy_cox, "cox_model_summary.csv")

# Evaluate Model Performance
# Concordance index
c_index <- summary(cox_model)$concordance
cat("Concordance Index:", c_index, "\n")
```

# 4. Model Building: Logistic Regression

# Model Diagnostics

```{r logit_diagnostics}
# Test for linearity
box_tidwell <- boxTidwell(Status ~ Age + Tumor.Size + Estrogen.Status + Progesterone.Status
                          + Regional.Node.Examined + Reginol.Node.Positive + 
                          T.Stage + N.Stage + X6th.Stage + Grade + A.Stage, 
                          data = data_cleaned)
print(box_tidwell)

logistic <- glm(Status ~ ., family = binomial, data = data_cleaned)

logit_vif_values <- vif(logistic)
print(logit_vif_values)
data_cleaned <- data_cleaned %>% 
  select(-X6th.Stage, -Reginol.Node.Positive)
```


## Varibales selection

```{r}
# Building model
logistic_full <- glm(Status ~ ., family = binomial, data = data_cleaned)
logistic_null <- glm(Status ~ 1, family = binomial, data = data_cleaned)

# backward selection
backward_model <- step(logistic_full, direction = "backward")
AIC(backward_model)

# forward selection
forward_model <- step(logistic_null, scope = list(lower = logistic_full, upper = logistic_null), direction = "forward")
AIC(forward_model)

# stepwise selection
stepwise <- step(null_logistic, scope = list(lower = logistic_full, upper = logistic_null), direction = "both")
AIC(stepwise)

# examine if the same model was build
formula(backward_model)
formula(forward_model)
formula(stepwise)

# check if there is a close call
summary(backward_model)
summary(forward_model)
summary(stepwise)

# results
results <- data.frame(
Model = c("forward", "backward", "stepwise"),
AIC = c(AIC(forward_model), AIC(backward_model), AIC(stepwise)), BIC = c(BIC(forward_model), BIC(backward_model), BIC(stepwise))
) 
results
```

# logistic regression
```{r}
logistics <- glm(Status ~ Age + Race + T.Stage + N.Stage + Grade + Estrogen.Status + 
    Progesterone.Status + Regional.Node.Examined + Reginol.Node.Positive + 
    Survival.Months, family = binomial, data = data_cleaned)
summary(logistics)
```



# 4. Fairness Analysis


